version: "1"

vars:
  go_packages: "./..."

checks:
  - id: vet
    run: go vet {{.go_packages}}
    severity: error
    suggestion: "go vet found issues in the codebase"
    fix: "go vet ./..."
    timeout: 5s

  - id: fmt
    run: test -z "$(gofmt -l .)"
    severity: error
    suggestion: "Code is not properly formatted"
    fix: "gofmt -w ."
    timeout: 5s

  - id: lint
    run: golangci-lint run {{.go_packages}}
    severity: error
    suggestion: "golangci-lint found lint issues"
    fix: "golangci-lint run ./..."
    timeout: 5s

  - id: test
    run: go test {{.go_packages}}
    severity: warning
    suggestion: "Some tests are failing"
    fix: "go test ./..."
    timeout: 20s

  - id: test-coverage
    run: go test ./... -coverprofile cover.out && go tool cover -func cover.out
    grok:
      - total:.*\(statements\)\s+%{NUMBER:coverage}%
    assert: "coverage >= 89"
    suggestion: "Coverage is {{.coverage}}%, need 89%"
    fix: "Add more test cases to improve coverage"
    timeout: 20s

  - id: build
    run: go build -o vibeguard ./cmd/vibeguard
    severity: error
    suggestion: "Build failed with compilation errors"
    fix: "go build -o vibeguard ./cmd/vibeguard"
    timeout: 5s
    requires:
      - vet

  - id: mutation
    run: gremlins unleash ./internal/assert --threshold-efficacy 50
    severity: warning
    suggestion: "Mutation testing found weak tests (efficacy below 50%)"
    fix: "gremlins unleash ./internal/assert"
    timeout: 120s
    requires:
      - test