version: "1"

vars:
  go_packages: "./..."

checks:
  - id: vet
    run: go vet {{.go_packages}}
    severity: error
    suggestion: "Run 'go vet ./...' and fix reported issues"
    timeout: 5s

  - id: fmt
    run: test -z "$(gofmt -l .)"
    severity: error
    suggestion: "Run 'gofmt -w .' to format code"
    timeout: 5s

  - id: lint
    run: golangci-lint run {{.go_packages}}
    severity: warning
    suggestion: "Install golangci-lint and run 'golangci-lint run' to fix reported issues"
    timeout: 5s

  - id: test
    run: go test {{.go_packages}}
    severity: warning
    suggestion: "Run 'go test ./...' to ensure all tests pass"
    timeout: 5s

  - id: test-coverage
    run: go test ./... -coverprofile cover.out & go tool cover -func cover.out
    grok:
      - total:.*\(statements\)\s+%{NUMBER:coverage}%
    assert: "coverage >= 80"
    suggestion: "Coverage is below 80%"
    timeout: 5s

  - id: build
    run: go build {{.go_packages}}
    severity: error
    suggestion: "Run 'go build ./...' and fix compilation errors"
    timeout: 5s
    requires:
      - vet

  # - id: error
  #   run: exit 1
  #   severity: error
  #   suggestion: "This check is designed to fail the pipeline. Use it to test error handling in vibeguard."
  #   timeout: 120s

  # - id: timeout
  #   run: sleep 10
  #   severity: error
  #   suggestion: "This check is designed to test timeout handling in vibeguard. It will fail if it runs longer than the specified timeout."
  #   timeout: 1s