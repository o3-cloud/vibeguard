version: "1"

vars:
  go_packages: "./..."

prompts:

  - id: fix
    description: Guidance for fixing issues identified by VibeGuard
    content: |
      You are an expert in helping users resolve issues found by VibeGuard.

      Guide them through:
      1. Understanding the specific issue and its impact
      2. Identifying the root cause of the problem
      3. Providing step-by-step solutions to fix the issue
      4. Verifying the fix and ensuring no regressions
      5. Implment the fix in the codebase

    tags: [fix, resolution, guidance]

checks:
  - id: vet
    run: go vet {{.go_packages}}
    severity: error
    on:
      failure:
        - fix
    timeout: 5s
    tags: [lint, fast, pre-commit, build]

  - id: fmt
    run: test -z "$(gofmt -l .)"
    severity: error
    suggestion: "Code is not properly formatted"
    fix: "Fix the formatting issues"
    timeout: 5s
    tags: [format, fast, pre-commit]

  - id: actionlint
    run: actionlint
    severity: error
    on:
      failure:
        - fix
    timeout: 10s
    tags: [lint, ci]

  - id: lint
    run: golangci-lint run {{.go_packages}}
    severity: error
    on:
      failure:
        - fix
    timeout: 5s
    tags: [lint, fast, pre-commit]

  - id: staticcheck
    run: staticcheck {{.go_packages}}
    severity: error
    on:
      failure:
        - fix
    timeout: 5s
    tags: [lint, security, fast, pre-commit]

  - id: test
    run: go test -race {{.go_packages}}
    severity: warning
    on:
      failure:
        - fix
    timeout: 20s
    tags: [test, pre-commit]

  - id: test-coverage
    run: go test ./... -coverprofile cover.out && go tool cover -func cover.out
    grok:
      - total:.*\(statements\)\s+%{NUMBER:coverage}%
    assert: "coverage >= 89"
    on:
      failure:
        - fix
    timeout: 20s
    tags: [test, ci]

  - id: build
    run: go build -o vibeguard ./cmd/vibeguard
    severity: error
    on:
      failure:
        - fix
    timeout: 5s
    tags: [build, fast, pre-commit]
    requires:
      - vet

  - id: gosec
    run: gosec {{.go_packages}}
    severity: error
    on:
      failure:
        - fix
    timeout: 30s
    tags: [security, slow, ci]

  - id: docker
    run: checkov -d . --framework dockerfile
    severity: error
    on:
      failure:
        - fix
    timeout: 30s
    tags: [security, ci, slow]