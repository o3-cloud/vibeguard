---
summary: Planned goreleaser integration for multi-platform releases with two-workflow pattern
event_type: deep dive
sources:
  - Current: .github/workflows/release.yml
  - Current: internal/version/version.go
  - Current: go.mod (Go 1.24.4)
  - GoReleaser docs: https://goreleaser.com
tags:
  - release-automation
  - goreleaser
  - ci-cd
  - github-actions
  - versioning
  - homebrew
  - sbom
  - supply-chain-security
---

# GoReleaser Integration Planning

## Context

Task: **vibeguard-apx** - Set up automated release with goreleaser and GitHub Actions

User requirements:
- Keep standard-version + Conventional Commits workflow (don't replace)
- Use goreleaser ONLY for multi-platform builds and artifact uploads
- Produce: raw binaries, .tar.gz/.zip archives, SHA256 checksums, SBOM
- Homebrew: start with custom tap, plan for homebrew-core migration later

## Current State Analysis

### Release Workflow (Existing)
- **Trigger**: Push to main branch
- **Versioning**: standard-version (Node.js-based, Conventional Commits)
- **Tagging**: Automatic git tags (format: v0.2.0, v0.3.0, etc.)
- **Changelog**: Auto-generated by standard-version
- **Builds**: Manual Go cross-compilation (4 platforms)
- **Artifacts**: Raw binaries only (no archives, checksums, or SBOM)

### Build Targets
1. Linux x86_64: `vibeguard-linux-amd64`
2. macOS x86_64: `vibeguard-darwin-amd64`
3. macOS ARM64: `vibeguard-darwin-arm64`
4. Windows x86_64: `vibeguard-windows-amd64.exe`

### Version Management
- **Source**: `internal/version/version.go` (default: v0.1.0-dev)
- **Injection**: Go build ldflags support already present
- **Runtime**: `vibeguard --version` flag (via Cobra CLI)
- **Build-time override**: `-ldflags="-X github.com/vibeguard/vibeguard/internal/version.Version=..."`

### Go Version Status
- **Local development**: Go 1.24.4 (in go.mod)
- **CI workflows**: Go 1.21 (outdated, should sync)
- **Recommendation**: Update CI to 1.24.4 for consistency

## Recommended Architecture: Two-Workflow Pattern

### Why Two Workflows?

**Option A: Single Workflow** (current approach modified)
- Pros: Simple, all in one place
- Cons: Coupling between versioning and building, slower feedback

**Option B: Two Workflows** ✓ **SELECTED**
- `release.yml`: Handles versioning, creates git tags
- `goreleaser.yml`: Triggered on tags, builds and uploads
- Pros: Clean separation, reusable, independent concerns, faster feedback

### Workflow 1: release.yml (Modified)

**Trigger**: `push` to `main`

**Responsibilities**:
- Run standard-version (versioning)
- Generate/update CHANGELOG.md
- Create git tags
- Push tags to GitHub
- **Does NOT build binaries**

**Changes**:
- Remove lines 42-111 (all manual build + upload steps)
- Update Go version: 1.21 → 1.24.4 (consistency)
- Keep everything else (Node setup, standard-version, git push)

**Result**: Simplified from ~112 lines to ~40 lines

### Workflow 2: goreleaser.yml (New)

**Trigger**: `push` with tags matching `v*` pattern

**Responsibilities**:
- Build all platforms
- Generate archives (.tar.gz, .zip)
- Generate checksums (SHA256)
- Generate SBOM (CycloneDX)
- Upload to GitHub Release
- Create GitHub Release automatically

**Steps**:
1. Checkout (fetch-depth: 0)
2. Setup Go 1.24.4
3. Setup/install GoReleaser
4. Run `goreleaser release --clean`
5. Permissions: `contents: write`

**Benefit**: Can be manually triggered locally with `goreleaser release` command

## GoReleaser Configuration (.goreleaser.yaml)

### Build Configuration
- **Entry point**: `./cmd/vibeguard/main.go`
- **Binary name**: `vibeguard`
- **Platforms**: 4 targets (linux/amd64, darwin/amd64, darwin/arm64, windows/amd64)
- **ldflags**: `-X github.com/vibeguard/vibeguard/internal/version.Version={{.Version}}`

### Version Injection Strategy
- **No code changes needed** to `internal/version/version.go`
- GoReleaser reads git tag (e.g., `v0.2.0`)
- Passes to linker: `-X github.com/vibeguard/vibeguard/internal/version.Version=v0.2.0`
- Binary compiled with version = `v0.2.0`
- `vibeguard --version` outputs injected version

### Artifact Strategy
Per release, produce:

**Raw Binaries** (4):
- `vibeguard-linux-amd64`
- `vibeguard-darwin-amd64`
- `vibeguard-darwin-arm64`
- `vibeguard-windows-amd64.exe`

**Archives** (4):
- `vibeguard_v0.2.0_linux_amd64.tar.gz`
- `vibeguard_v0.2.0_darwin_amd64.tar.gz`
- `vibeguard_v0.2.0_darwin_arm64.tar.gz`
- `vibeguard_v0.2.0_windows_amd64.zip`

**Checksums**:
- `vibeguard_v0.2.0_checksums.txt` (SHA256 for all artifacts)

**SBOM**:
- `vibeguard_v0.2.0_sbom.json` (CycloneDX format for supply chain security)

### Release Notes
- Use CHANGELOG.md (auto-generated by standard-version)
- GoReleaser automatically includes in GitHub Release

## Homebrew Integration

### Custom Tap Strategy (Start Here)

**Repository**: `github.com/vibeguard/homebrew-vibeguard`

**Structure**:
```
homebrew-vibeguard/
├── Formula/
│   └── vibeguard.rb        (auto-generated by GoReleaser)
├── README.md               (install instructions)
└── .gitignore
```

**GoReleaser Configuration**:
- `brews` section defines tap integration
- Auto-generates formula on each release
- Auto-commits and pushes to tap repo
- Requires GitHub token with push access to tap

**Installation**:
```bash
brew tap vibeguard/homebrew-vibeguard https://github.com/vibeguard/homebrew-vibeguard
brew install vibeguard
```

**Testing**:
```bash
brew audit --new-formula Formula/vibeguard.rb
brew install --HEAD ./Formula/vibeguard.rb
vibeguard --version
```

### Future Migration Path
- Submit to homebrew-core once project matures
- Requires 30-day stability, no breaking changes
- Custom tap acts as staging ground

## Testing Strategy

### Local Testing (No GitHub Needed)

**Prerequisites**:
```bash
brew install goreleaser
# Go 1.24.4 already installed (from go.mod)
```

**Dry-run build**:
```bash
goreleaser build --clean
# Outputs to ./dist/vibeguard_v0.1.0-dev_linux_amd64/, etc.
```

**Full release simulation**:
```bash
git tag v0.2.0
goreleaser release --clean --skip=publish
# Validates builds, archives, checksums, SBOM in ./dist/
```

**Validate artifacts**:
```bash
# Extract and test binary
tar -xzf dist/vibeguard_v0.2.0_linux_amd64.tar.gz
./vibeguard --version  # Should output: v0.2.0

# Verify checksums
cd dist
sha256sum -c vibeguard_v0.2.0_checksums.txt

# Inspect SBOM
cat vibeguard_v0.2.0_sbom.json | jq .
```

### GitHub Actions Testing

1. Create test branch, push to trigger workflows
2. Monitor GitHub Actions for success
3. Check GitHub Release page for all artifacts
4. Download and test artifacts locally

### Validation Checklist

Pre-implementation:
- [ ] `.goreleaser.yaml` validates: `goreleaser check`
- [ ] Review plan in docs/log
- [ ] GitHub workflows syntax valid

Post-implementation:
- [ ] Local `goreleaser build --clean` succeeds
- [ ] All 4 binaries build and execute
- [ ] Archives contain correct files
- [ ] Checksums validate
- [ ] SBOM is valid JSON
- [ ] GitHub Actions workflows run successfully
- [ ] Test release on GitHub succeeds
- [ ] Homebrew formula installs
- [ ] `vibeguard --version` works after brew install
- [ ] CI passes with Go 1.24.4 everywhere

## Files to Create/Modify

### CREATE (2 new files)
- `.goreleaser.yaml` (~150-200 lines)
- `.github/workflows/goreleaser.yml` (~60-80 lines)

### MODIFY (5 files)
- `.github/workflows/release.yml` - Remove manual builds, update Go version
- `.github/workflows/ci.yml` - Update Go 1.21 → 1.24.4
- `RELEASE.md` - Document new workflow
- `.gitignore` - Add `dist/`
- `README.md` - Add Homebrew installation instructions

### OPTIONAL
- `docs/adr/ADR-009-adopt-goreleaser.md` - Architecture decision record
- New GitHub repo: `vibeguard/homebrew-vibeguard` - Custom tap

## Key Design Decisions

1. **Keep standard-version**: Preserves Conventional Commits workflow
2. **Two-workflow pattern**: Clean separation of concerns
3. **Version injection via ldflags**: No code changes needed
4. **GoReleaser for builds only**: Focused responsibility
5. **Custom tap first**: Reduces friction for adoption, path to homebrew-core later
6. **Go version consistency**: Update CI to match local development (1.24.4)

## Next Steps

1. Review plan (this log entry)
2. Create `.goreleaser.yaml` with full configuration
3. Create `.github/workflows/goreleaser.yml`
4. Modify existing workflow files
5. Create `vibeguard/homebrew-vibeguard` repository
6. Local testing: `goreleaser build --clean`
7. Update documentation
8. Test on GitHub Actions
9. Close task vibeguard-apx

## Related ADRs

- **ADR-002**: Adopt Conventional Commits (relates to versioning)
- **ADR-005**: Adopt Vibeguard for Policy Enforcement (CI/CD context)
- **ADR-006**: Integrate VibeGuard as Git Pre-Commit Hook (CI/CD tooling)

## References

- GoReleaser Documentation: https://goreleaser.com
- Homebrew Formula Cookbook: https://docs.brew.sh/Formula-Cookbook
- CycloneDX SBOM Format: https://cyclonedx.org/
