# Go Project Example: Comprehensive Quality Checks
# This example demonstrates a complete quality gate for Go projects,
# including formatting, linting, testing, and coverage validation.

version: "1"

vars:
  go_packages: "./..."
  min_coverage: "70"

checks:
  # Format check
  - id: fmt
    run: test -z "$(gofmt -l .)"
    severity: error
    suggestion: "Run 'gofmt -w .' to format your code"
    fix: "gofmt -w ."
    timeout: 5s

  # Vet check
  - id: vet
    run: go vet {{.go_packages}}
    severity: error
    suggestion: "Run 'go vet ./...' and fix reported issues"
    fix: "go vet {{.go_packages}}"
    timeout: 10s

  # Lint check (requires golangci-lint installed)
  - id: lint
    run: golangci-lint run {{.go_packages}}
    severity: warning
    suggestion: "Install golangci-lint: https://golangci-lint.run/usage/install/"
    fix: "golangci-lint run {{.go_packages}} --fix"
    timeout: 30s

  # Unit tests
  - id: test
    run: go test {{.go_packages}}
    severity: error
    suggestion: "Run 'go test ./...' to diagnose test failures"
    fix: "go test {{.go_packages}} -v"
    timeout: 60s
    requires:
      - fmt

  # Test coverage validation
  - id: coverage
    run: go test {{.go_packages}} -coverprofile=cover.out && go tool cover -func=cover.out
    grok:
      - total:.*\(statements\)\s+%{NUMBER:coverage}%
    assert: "coverage >= {{.min_coverage}}"
    severity: warning
    suggestion: "Code coverage is {{.coverage}}%, need {{.min_coverage}}%. Add more tests."
    fix: "go test {{.go_packages}} -coverprofile=cover.out && go tool cover -html=cover.out"
    timeout: 60s
    requires:
      - test

  # Build check
  - id: build
    run: go build {{.go_packages}}
    severity: error
    suggestion: "Run 'go build ./...' to diagnose build errors"
    fix: "go build {{.go_packages}}"
    timeout: 30s
    requires:
      - vet
